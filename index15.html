<style>
  .ttooltip {
    z-index: 99
  }
</style>

<body>
  <h1>Welcome to a demo/test page.</h1>
  <div id="deepscatter"></div>
  <div id="controls" style="z-index:99;position:fixed;">
    <label for="label">Label:</label>
    <select name="cat" id="cat-select">
      <option value="">--Please choose an option--</option>
      <option value="id">ID</option>
      <option value="subject">Subject</option>
      <option value="size">Size</option>
    </select>
    <label for="keyword">Search:</label>
    <input id="keyword" />
    <pre id="ident"></pre>
  </div>
</body>

<head>
  <style>
    dt {
      float: left;
      clear: left;
      width: 90px;
      font-weight: bold;
      color: rgb(128, 19, 0);
    }

    dt::after {
      content: ":";
    }

    dd {
      margin: 0 0 0 80px;
      padding: 0 0 0.5em 0;
      width: 180px;
    }
  </style>
</head>

<script type="module">
  import Scatterplot from './src/deepscatter';
  import { select } from 'd3-selection';
  import {
  scaleLinear,
  scaleTime,
  scaleOrdinal
} from 'd3-scale';
  window.select = select; // For the click function below.
  window.scaleOrdinal = scaleOrdinal;
  const prefs = {
    "source_url": "/tiles",
    "max_points": 10000000, // a full cap.
    "alpha": 100, // Target saturation for the full page.
    "zoom_balance": 0.3, // Rate at which points increase size. https://observablehq.com/@bmschmidt/zoom-strategies-for-huge-scatterplots-with-three-js
    "point_size": 0.02, // Default point size before application of size scaling
    "background_color": "#000000",
    "click_function": "select('#ident').html(JSON.stringify(datum, undefined, 2))",
    "encoding": {

      "x": {
        field: "x",
        transform: "linear",
        "domain": [-1000000,1000000],
        "range": [-1000000, 1000000]
      },

      "y": {
        field: "y",
        transform: "linear",
        "domain": [-1000000,1000000],
        "range": [-1000000, 1000000]
      },
      "size": {
        "field": "size",
        "transform": "sqrt",
        "domain": [5, 1000],
        "range": [5, 1000]
      },
      "color": {
        "field": "subject",
        "range": "category10",
        "domain": [-2047,2047]
      },
      // filter: {
      //   field: "size",
      //   op: "gt",
      //   a: 10,
      // },
      // filter2: {
      //   field: "published_year",
      //   op: "lt",
      //   a: 1990,
      // }
    }
  };
  //list of ids 1 - 100000
  var ids_1 = [];
  var ids_2 = [];
  for (var i = 1; i < 500000; i++) {
    ids_1.push(i.toString());
  }

  //list of ids 1 - 20000 increment by 2
  for (var i = 1; i < 20000; i++) {
    ids_2.push(i.toString());
  }
  const colors = [
    //    JSON.parse(JSON.stringify(prefs.encoding.color)),
    {
      "field": 'quantity',
      "range": 'ylorrd',
      //      "domain": 'progressive',
    },
  ]

  const scatterplot = new Scatterplot("#deepscatter")
  scatterplot.plotAPI(prefs).then(d => scatterplot.plotAPI(prefs));
  window.plot = scatterplot; // For debugging
  console.log(scatterplot)
  console.log(scatterplot.database)
  // Simple animation demonstration.

  // In practice, you might transform an external annotations layer using this

  let cycle = 0;
  document.getElementById("keyword").addEventListener("keypress", function (e) {
    var label = document.getElementById("cat-select").value;
    var keyword = document.getElementById("keyword").value;
    if (keyword !== undefined) {
      var keyword_lower = keyword.toLowerCase();
    }
    if (label !== "") {
      if (e.keyCode === 13) {
        var new_coding = null;
        if (label === 'subject') {
          new_coding = {
            // eslint-disable-next-line
            "encoding": {
              filter: {
                field: "subject",
                lambda: `value => String(value).toLowerCase().includes("${keyword_lower}")`
              }
            }
          }
        }
        else if (label === "size") {
          new_coding = {
            // eslint-disable-next-line
            "encoding": {
              filter: {
                field: "size",
                op: 'gt',
                a: keyword
              }
            }
          }
        }
        else {
          new_coding = {
            // eslint-disable-next-line
            "encoding": {
              filter: {
                field: "paper_id",
                op: 'eq',
                a: keyword
              }
            }
          }
        }

        scatterplot.plotAPI(new_coding).then(d => scatterplot.plotAPI(new_coding));
      }

    }
  }

  )


</script>